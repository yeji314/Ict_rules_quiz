openapi: 3.0.3
info:
  title: ICT Rules Quiz API
  description: |
    내규 퀴즈 게임 시스템 API
    SDD(Schema Driven Development) 방식으로 설계되었습니다.
  version: 1.0.0
  contact:
    name: ICT Quiz Team

servers:
  - url: http://localhost:3000/api
    description: Development server
  - url: https://api.ict-quiz.com/api
    description: Production server

tags:
  - name: Auth
    description: 인증 관련 API
  - name: Quizzes
    description: 퀴즈 조회 API
  - name: Game
    description: 게임 진행 API
  - name: Admin
    description: 관리자 API

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    # ========================================
    # 기본 스키마
    # ========================================

    Error:
      type: object
      properties:
        error:
          type: string
        message:
          type: string
      required:
        - error
        - message

    Success:
      type: object
      properties:
        success:
          type: boolean
        message:
          type: string

    # ========================================
    # 사용자 관련 스키마
    # ========================================

    User:
      type: object
      properties:
        id:
          type: string
          format: uuid
        employeeId:
          type: string
        name:
          type: string
        departmentId:
          type: string
          format: uuid
        department:
          $ref: '#/components/schemas/Department'
        role:
          type: string
          enum: [ADMIN, USER]
      required:
        - id
        - employeeId
        - name
        - role

    Department:
      type: object
      properties:
        id:
          type: string
          format: uuid
        code:
          type: string
        name:
          type: string
      required:
        - id
        - code
        - name

    # ========================================
    # 퀴즈 관련 스키마
    # ========================================

    Quiz:
      type: object
      properties:
        id:
          type: string
          format: uuid
        title:
          type: string
          example: "2025년 10월"
        description:
          type: string
        startDate:
          type: string
          format: date-time
        endDate:
          type: string
          format: date-time
        isActive:
          type: boolean
        maxRounds:
          type: integer
          default: 3
        questionsPerRound:
          type: integer
          default: 5
        totalQuestions:
          type: integer
          description: 총 문제 수
        totalLuckyDrawQuestions:
          type: integer
          description: LuckyDraw 문제 수
      required:
        - id
        - title
        - startDate
        - endDate

    QuizWithProgress:
      allOf:
        - $ref: '#/components/schemas/Quiz'
        - type: object
          properties:
            progress:
              $ref: '#/components/schemas/UserQuizProgress'

    UserQuizProgress:
      type: object
      properties:
        id:
          type: string
          format: uuid
        currentRound:
          type: integer
          minimum: 0
          maximum: 3
        totalQuestionsAnswered:
          type: integer
        luckyDrawBadges:
          type: integer
        firstAttemptDate:
          type: string
          format: date-time
        lastAttemptDate:
          type: string
          format: date-time
        isCompleted:
          type: boolean
        buttonStatus:
          type: string
          enum: [START, CONTINUE, COMPLETED]
          description: |
            - START: 시작하기 (currentRound == 0)
            - CONTINUE: 계속하기 (0 < currentRound < 3)
            - COMPLETED: 완료 (currentRound == 3 또는 유효기간 종료)

    # ========================================
    # 문제 관련 스키마
    # ========================================

    Question:
      type: object
      properties:
        id:
          type: string
          format: uuid
        quizId:
          type: string
          format: uuid
        type:
          type: string
          enum: [DRAG_AND_DROP, TYPE_SENTENCE, FILL_BLANK, OX_QUIZ, FIND_ERROR]
        content:
          type: string
        options:
          type: object
          nullable: true
          description: 문제 유형별 선택지
        correctAnswer:
          type: object
          description: 정답 (관리자만 볼 수 있음)
        explanation:
          type: string
          description: 해설
        isLuckyDraw:
          type: boolean
        metadata:
          type: object
          nullable: true
      required:
        - id
        - type
        - content
        - isLuckyDraw

    QuestionForUser:
      type: object
      description: 사용자에게 제공되는 문제 (정답 제외)
      properties:
        id:
          type: string
          format: uuid
        type:
          type: string
          enum: [DRAG_AND_DROP, TYPE_SENTENCE, FILL_BLANK, OX_QUIZ, FIND_ERROR]
        content:
          type: string
        options:
          type: object
          nullable: true
        isLuckyDraw:
          type: boolean
        metadata:
          type: object
          nullable: true

    # ========================================
    # 게임 세션 관련 스키마
    # ========================================

    QuizSession:
      type: object
      properties:
        id:
          type: string
          format: uuid
        userId:
          type: string
          format: uuid
        quizId:
          type: string
          format: uuid
        roundNumber:
          type: integer
          minimum: 1
          maximum: 3
        status:
          type: string
          enum: [IN_PROGRESS, COMPLETED, ABANDONED]
        startedAt:
          type: string
          format: date-time
        completedAt:
          type: string
          format: date-time
          nullable: true
        questionsCount:
          type: integer
        correctFirstTry:
          type: integer
        luckyDrawShown:
          type: boolean
      required:
        - id
        - roundNumber
        - status

    Answer:
      type: object
      properties:
        id:
          type: string
          format: uuid
        questionId:
          type: string
          format: uuid
        userAnswer:
          type: object
          description: 사용자가 제출한 답변
        isCorrect:
          type: boolean
        attemptCount:
          type: integer
        isFirstTryCorrect:
          type: boolean
        answeredAt:
          type: string
          format: date-time

    AnswerSubmission:
      type: object
      properties:
        questionId:
          type: string
          format: uuid
        userAnswer:
          type: object
          description: 사용자 답변 (문제 유형에 따라 구조 다름)
      required:
        - questionId
        - userAnswer

    AnswerResult:
      type: object
      properties:
        isCorrect:
          type: boolean
        correctAnswer:
          type: object
          description: 틀렸을 경우에만 제공
        explanation:
          type: string
          description: 해설
        attemptCount:
          type: integer
        canProceed:
          type: boolean
          description: 다음 문제로 넘어갈 수 있는지 (정답인 경우 true)

    # ========================================
    # 관리자 관련 스키마
    # ========================================

    AdminStats:
      type: object
      properties:
        departmentParticipation:
          type: array
          items:
            type: object
            properties:
              departmentName:
                type: string
              totalUsers:
                type: integer
              participatedUsers:
                type: integer
              participationRate:
                type: number
                format: float
        luckyDrawStats:
          type: array
          items:
            type: object
            properties:
              userName:
                type: string
              departmentName:
                type: string
              luckyDrawCount:
                type: integer

    QuestionBulkCreate:
      type: object
      properties:
        questions:
          type: array
          items:
            $ref: '#/components/schemas/QuestionInput'
      required:
        - questions

    QuestionInput:
      type: object
      properties:
        type:
          type: string
          enum: [DRAG_AND_DROP, TYPE_SENTENCE, FILL_BLANK, OX_QUIZ, FIND_ERROR]
        content:
          type: string
        options:
          type: object
          nullable: true
        correctAnswer:
          type: object
        explanation:
          type: string
        isLuckyDraw:
          type: boolean
          default: false
        metadata:
          type: object
          nullable: true
      required:
        - type
        - content
        - correctAnswer

# ========================================
# API 엔드포인트
# ========================================

paths:
  # ========================================
  # 인증 (Auth)
  # ========================================

  /auth/login:
    post:
      tags:
        - Auth
      summary: 로그인
      description: 행원번호와 비밀번호로 로그인
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                employeeId:
                  type: string
                  example: "admin"
                password:
                  type: string
                  example: "admin@"
              required:
                - employeeId
                - password
      responses:
        '200':
          description: 로그인 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  token:
                    type: string
                    description: JWT 토큰
                  user:
                    $ref: '#/components/schemas/User'
        '401':
          description: 인증 실패
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /auth/logout:
    post:
      tags:
        - Auth
      summary: 로그아웃
      security:
        - bearerAuth: []
      responses:
        '200':
          description: 로그아웃 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Success'

  /auth/me:
    get:
      tags:
        - Auth
      summary: 현재 로그인한 사용자 정보
      security:
        - bearerAuth: []
      responses:
        '200':
          description: 사용자 정보
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/User'

  # ========================================
  # 퀴즈 (Quizzes)
  # ========================================

  /quizzes:
    get:
      tags:
        - Quizzes
      summary: 퀴즈 목록 조회
      description: 사용자의 진행 상황과 함께 퀴즈 목록을 반환
      security:
        - bearerAuth: []
      responses:
        '200':
          description: 퀴즈 목록
          content:
            application/json:
              schema:
                type: object
                properties:
                  quizzes:
                    type: array
                    items:
                      $ref: '#/components/schemas/QuizWithProgress'

  /quizzes/{quizId}:
    get:
      tags:
        - Quizzes
      summary: 퀴즈 상세 조회
      security:
        - bearerAuth: []
      parameters:
        - name: quizId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: 퀴즈 상세 정보
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QuizWithProgress'

  /quizzes/{quizId}/progress:
    get:
      tags:
        - Quizzes
      summary: 내 진행 상황 조회
      security:
        - bearerAuth: []
      parameters:
        - name: quizId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: 진행 상황
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserQuizProgress'

  # ========================================
  # 게임 (Game)
  # ========================================

  /sessions:
    post:
      tags:
        - Game
      summary: 새 게임 세션 시작
      description: 퀴즈의 새 회차를 시작합니다
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                quizId:
                  type: string
                  format: uuid
              required:
                - quizId
      responses:
        '201':
          description: 세션 생성 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QuizSession'

  /sessions/{sessionId}/questions:
    get:
      tags:
        - Game
      summary: 세션의 문제 가져오기
      description: |
        현재 세션에서 풀어야 할 문제를 반환합니다.
        - 랜덤으로 선택된 5개 문제
        - 이전에 푼 문제는 제외
        - LuckyDraw 출현 조건 충족 시 포함 가능
      security:
        - bearerAuth: []
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: 문제 목록
          content:
            application/json:
              schema:
                type: object
                properties:
                  questions:
                    type: array
                    items:
                      $ref: '#/components/schemas/QuestionForUser'
                  currentQuestionIndex:
                    type: integer
                    description: 현재 풀고 있는 문제 인덱스 (0-4)

  /sessions/{sessionId}/answers:
    post:
      tags:
        - Game
      summary: 답변 제출
      description: |
        사용자의 답변을 제출하고 채점 결과를 반환합니다.
        - 틀린 경우: 오답노트(해설)와 정답을 보여줌
        - 맞은 경우: 다음 문제로 넘어갈 수 있음
      security:
        - bearerAuth: []
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AnswerSubmission'
      responses:
        '200':
          description: 채점 결과
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AnswerResult'

  /sessions/{sessionId}/complete:
    post:
      tags:
        - Game
      summary: 세션 완료/중단
      description: |
        - action: "continue" → 다음 세션 시작
        - action: "quit" → 세션 중단 (ABANDONED)
      security:
        - bearerAuth: []
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                action:
                  type: string
                  enum: [continue, quit]
              required:
                - action
      responses:
        '200':
          description: 세션 완료
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    enum: [COMPLETED, ABANDONED]
                  nextSession:
                    $ref: '#/components/schemas/QuizSession'
                    description: action이 "continue"인 경우에만 제공

  # ========================================
  # 관리자 (Admin)
  # ========================================

  /admin/stats:
    get:
      tags:
        - Admin
      summary: 대시보드 통계
      description: 부서별 참여율 및 LuckyDraw 현황
      security:
        - bearerAuth: []
      responses:
        '200':
          description: 통계 데이터
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AdminStats'

  /admin/quizzes:
    get:
      tags:
        - Admin
      summary: 전체 퀴즈 관리 목록
      security:
        - bearerAuth: []
      responses:
        '200':
          description: 퀴즈 목록
          content:
            application/json:
              schema:
                type: object
                properties:
                  quizzes:
                    type: array
                    items:
                      $ref: '#/components/schemas/Quiz'

    post:
      tags:
        - Admin
      summary: 새 퀴즈 생성
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                title:
                  type: string
                  example: "2025년 11월"
                description:
                  type: string
                startDate:
                  type: string
                  format: date-time
                endDate:
                  type: string
                  format: date-time
              required:
                - title
                - startDate
                - endDate
      responses:
        '201':
          description: 퀴즈 생성 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Quiz'

  /admin/quizzes/{quizId}:
    put:
      tags:
        - Admin
      summary: 퀴즈 수정
      security:
        - bearerAuth: []
      parameters:
        - name: quizId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                title:
                  type: string
                description:
                  type: string
                startDate:
                  type: string
                  format: date-time
                endDate:
                  type: string
                  format: date-time
                isActive:
                  type: boolean
      responses:
        '200':
          description: 퀴즈 수정 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Quiz'

    delete:
      tags:
        - Admin
      summary: 퀴즈 삭제
      security:
        - bearerAuth: []
      parameters:
        - name: quizId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: 삭제 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Success'

  /admin/quizzes/{quizId}/questions:
    get:
      tags:
        - Admin
      summary: 퀴즈의 전체 문제 조회
      security:
        - bearerAuth: []
      parameters:
        - name: quizId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: 문제 목록
          content:
            application/json:
              schema:
                type: object
                properties:
                  questions:
                    type: array
                    items:
                      $ref: '#/components/schemas/Question'

    post:
      tags:
        - Admin
      summary: 문제 추가
      security:
        - bearerAuth: []
      parameters:
        - name: quizId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/QuestionInput'
      responses:
        '201':
          description: 문제 생성 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Question'

    delete:
      tags:
        - Admin
      summary: 퀴즈의 전체 문제 삭제
      security:
        - bearerAuth: []
      parameters:
        - name: quizId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: 전체 삭제 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Success'

  /admin/questions/{questionId}:
    put:
      tags:
        - Admin
      summary: 문제 수정
      security:
        - bearerAuth: []
      parameters:
        - name: questionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/QuestionInput'
      responses:
        '200':
          description: 문제 수정 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Question'

    delete:
      tags:
        - Admin
      summary: 문제 삭제
      security:
        - bearerAuth: []
      parameters:
        - name: questionId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: 삭제 성공
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Success'

  /admin/questions/bulk:
    post:
      tags:
        - Admin
      summary: 문제 대량 등록
      security:
        - bearerAuth: []
      parameters:
        - name: quizId
          in: query
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/QuestionBulkCreate'
      responses:
        '201':
          description: 대량 등록 성공
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  count:
                    type: integer
                    description: 등록된 문제 수

  /admin/departments:
    get:
      tags:
        - Admin
      summary: 부서 목록 조회
      security:
        - bearerAuth: []
      responses:
        '200':
          description: 부서 목록
          content:
            application/json:
              schema:
                type: object
                properties:
                  departments:
                    type: array
                    items:
                      $ref: '#/components/schemas/Department'
